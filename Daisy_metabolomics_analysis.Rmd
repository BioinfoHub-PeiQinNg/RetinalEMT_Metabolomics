---
title: "Daisy Metabolomics analysis"
author: "Pei Qin (Sabrina) Ng"
date: "11/06/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Samples are H-RPE cells treated with TGFb2 or TNFa (cell + media metabolites)


Datasets were reformatted for analysis using Omu package
```{r}
library(readxl)
library(dplyr)
library(tibble)

data <- read_xlsx("mx_608189_Daisy Shu_human cells_ media_primary_metabolism_GC-TOF_MS_10-2021_submit.xlsx", sheet = "sub")
metadata <- read_xlsx("mx_608189_Daisy Shu_human cells_ media_primary_metabolism_GC-TOF_MS_10-2021_submit.xlsx", sheet = "metadata")

data <- data %>% 
        rename(Metabolite = "BinBase name")

#export as csv format
write.csv(data, "metabolics_raw_data.csv")

#transpose the original metadata format to suit omu package requirements

metadata <- t(metadata) %>% as.data.frame() %>% 
    tibble::rownames_to_column("mx_Lane") %>%
    select(V1,V3,V4,V2,V5) %>% 
    tidyr::unite(Background, c(V3,V4)) %>% 
    rename(Sample = V1, Treatment = V2, Grouped =V5)

write.csv(metadata, "metabolics_metadata.csv")
```

Reformatted data were used as input (CSV data) into Omu.

```{r}
library(omu)
library(dplyr)
library(tibble)

metabolomics_count_dataframe <- read_metabo(filepath = "metabolics_raw_data.csv")
metabolomics_metadata <- read.csv("metabolics_metadata.csv")

metabolomics_metadata <- mutate_if(metabolomics_metadata, 
                                   is.character, as.factor) %>%
                        subset(select = -c(X)) %>%as.data.frame()

metabolomics_count_dataframe_all  <- metabolomics_count_dataframe %>% 
                                     subset(select = -c(X,ret.index,
                                                   quant.mz,
                                                   BB.id,
                                                   mass.spec,
                                                   PubChem,
                                                   InChI.Key,
                                                   cells,media)) %>% 
                                                    as.data.frame()

#data reformatting for the purpose of PCA plot. Note PCAplot function for omu does not work too well with this dataset.
metabolomics_count_dataframe  <- metabolomics_count_dataframe %>% 
                                subset(select = -c(X,ret.index,
                                                   quant.mz,
                                                   BB.id,
                                                   mass.spec,
                                                   PubChem,
                                                   InChI.Key,
                                                   cells,media)) %>% as.tibble() %>% 
                                    select(Metabolite,X1_001:X48_048) %>%
                                    tidyr::pivot_longer(X1_001:X48_048, 
                                     names_to = "Sample", values_to = "peaks" ) %>% 
                                     tidyr::pivot_wider(names_from = Metabolite, values_from = peaks)





rownames(metabolomics_metadata) <- NULL

comb_data <- left_join(metabolomics_count_dataframe,
                       metabolomics_metadata, 
                       by = "Sample")


#Samples which are human cells 
cells_list <- comb_data %>% 
              filter(Background == "human_cells") %>% 
              distinct(Sample)

cells_counts_Df <- metabolomics_count_dataframe  %>% 
                    filter(Sample %in% cells_list$Sample) %>%
                 column_to_rownames("Sample")

#for annotation
cells_comb_data <- left_join(metabolomics_count_dataframe,
                       metabolomics_metadata, 
                       by = "Sample") %>% 
    relocate (Sample, Treatment) %>% 
             filter(Sample %in% cells_list$Sample)

#Samples which are media 
media_list <- comb_data %>% 
              filter(Background == "human_media") %>% 
              distinct(Sample)

media_counts_Df <- metabolomics_count_dataframe  %>% 
                    filter(Sample %in% media_list$Sample) %>%
                 column_to_rownames("Sample")

#for annotation
media_comb_data <- left_join(metabolomics_count_dataframe,
                       metabolomics_metadata, 
                       by = "Sample") %>% 
                   relocate (Sample, Treatment) %>% 
                  filter(Sample %in% media_list$Sample)

#only use up till this stage as this package is pretty useless
```


Split the data by:

1) Cell lines

2) media

PCA plots for each of these group in cells
```{r}
pca_res <- prcomp(sqrt(cells_counts_Df), center = TRUE, scale. = TRUE)

df <- as.data.frame(pca_res$x) %>% 
      rownames_to_column("Sample") %>% 
      mutate(Treatments = cells_comb_data$Treatment) %>% 
      select(Sample,Treatments, PC1:PC24)


ggplot(df, aes(PC1, PC2, colour = factor(Treatments))) + 
  geom_point(size = 3) +
  theme_bw() + labs(colour = "Groups")
  
#PCA_plot(count_data = cells_counts_log_Df, metadata = metabolomics_metadata, variable = "Treatment", color = "Treatment", response_variable = "Metabolites")+ theme_bw() + theme(panel.grid = element_blank())
```
PCA plots for each of these group in media
```{r}
pca_res_2 <- prcomp(sqrt(media_counts_Df), center = TRUE, scale. = TRUE)
df_2 <- as.data.frame(pca_res_2$x) %>% rownames_to_column("Sample") %>% mutate(Treatments = media_comb_data$Treatment) %>% select(Sample,Treatments, PC1:PC23)


ggplot(df_2, aes(PC1, PC2, colour = factor(Treatments))) + 
  geom_point(size = 3) +
  theme_bw() + labs(colour = "Groups")
```

Assigns hierarchy metadata to a metabolomics count matrix using identifier values. 
It can assign KEGG compound hierarchy, orthology hierarchy, or organism hierarchy data.

```{r}
DF <- assign_hierarchy(metabolomics_count_dataframe_all, 
                       keep_unknowns = FALSE, 
                       identifier = "KEGG" ) 


DF_stats <-omu_summary(count_data = DF , 
            metadata = metabolomics_metadata, 
            numerator = "Cells_Control", 
            denominator = "Cells_TNFa", 
            response_variable = "Metabolite", 
            Factor = "Treatment", 
            p_adjust = "BH", 
            test_type = "welch")


```

Generate stats of differential comparison of metabolites detetected in Cells_TNFa vs Cells_Control

```{r}
DF_stats_counts <- count_fold_changes(count_data = DF_stats, 
                                      column = "Class", 
                                      sig_threshold = 0.05, 
                                      keep_unknowns = FALSE)
```

Visualise results for Cells_TNFa vs Cells_control in barplot to show comparisons of metabolites

```{r}
library(ggplot2)
Class_Bar_Plot <- plot_bar(fc_data = DF_stats_counts, 
                           fill = c("dodgerblue2", "firebrick2"), 
                           outline_color = c("black", "black"), size = c(1,1)) + 
                  labs(x = "Class") + 
                  theme(panel.grid = element_blank()) + 
                ggtitle("Metabolites comparison between Cells_TNFa vs Cells_Control")
```

